<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Mypage</title>
    <script>
        // Access Token 갱신 함수
        async function refreshAccessToken() {
            try {
                const refreshResponse = await fetch('/api/v1/refresh', {
                    method: 'POST',
                    credentials: 'include', // Refresh Token 쿠키 포함
                });

                if (refreshResponse.ok) {
                    const newAccessToken = refreshResponse.headers.get('Authorization').split(' ')[1];
                    localStorage.setItem('jwt', newAccessToken);
                    return newAccessToken;
                } else {
                    alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                    window.location = '/user/login';
                }
            } catch (error) {
                console.error('Error refreshing access token:', error);
                alert('서버 에러가 발생했습니다. 다시 로그인해주세요.');
                window.location = '/user/login';
            }
        }

        // 사용자 정보를 가져오는 함수
        async function fetchUserData() {
            let token = localStorage.getItem('jwt');
            if (!token) {
                alert('로그인 정보가 없습니다.');
                window.location = '/user/login';
                return;
            }

            try {
                const response = await fetch('/api/user/mypage', {
                    method: 'GET',
                    credentials: "include",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('profile').src = user.profile;
                    document.getElementById('description').textContent = user.description;
                } else if (response.status === 401) { // Access Token 만료 시
                    token = await refreshAccessToken();
                    if (token) {
                        // 새 토큰으로 재요청
                        await fetchUserData();
                    }
                } else {
                    alert('사용자 정보를 가져올 수 없습니다.');
                    window.location = '/user/login';
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                alert('서버 에러가 발생했습니다.');
            }
        }

        // 페이지 로드 시 사용자 데이터 가져오기
        document.addEventListener('DOMContentLoaded', fetchUserData);
    </script>
</head>
<body>
<h1>Mypage</h1>
<table>
    <tr>
        <td>Username</td>
        <td id="username"></td>
    </tr>
    <tr>
        <td>Profile</td>
        <td><img id="profile" alt="Profile Image"></td>
    </tr>
    <tr>
        <td>Description</td>
        <td id="description"></td>
    </tr>
</table>
</body>
</html>
